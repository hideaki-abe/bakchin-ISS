<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒã‚«ãƒãƒ³ISS</title>
    <link rel="stylesheet" href="./css/reset.css">
    <link rel="stylesheet" href="./css/style.css">
    <link href="https://fonts.googleapis.com/earlyaccess/nicomoji.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
</head>

<body>

    <!-- ãƒ­ã‚°ã‚¤ãƒ³ãƒ»æ–°è¦ç™»éŒ²ãƒ•ã‚©ãƒ¼ãƒ  -->
    <div id="login-container" style="display: none;">
        <h2>ğŸ’€ãƒã‚«ãƒãƒ³æ©Ÿå¯†æƒ…å ±ã«æ¥ç¶šğŸ’€</h2>
        <input type="email" id="login-email" placeholder="ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹">
        <input type="password" id="login-password" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰">
        <button id="login-button">ãƒ­ã‚°ã‚¤ãƒ³</button>

        <h2>ğŸš€æ–°è¦ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ç™»éŒ²ğŸŒ</h2>
        <input type="email" id="signup-email" placeholder="ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹">
        <input type="password" id="signup-password" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰">
        <button id="signup-button">ç™»éŒ²</button>
    </div>

    <!-- ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ç”»é¢ï¼ˆãƒ­ã‚°ã‚¤ãƒ³å¾Œè¡¨ç¤ºï¼‰ -->
    <div id="content-container" style="display: none;">
        <h1>ãƒã‚«ãƒãƒ³<span>â˜…</span>å›½éš›å®‡å®™ã‚¹ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³</h1>
        <h2>ï½ è‡³æ€¥ã€å›½éš›å®‡å®™ã‚¹ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆISSï¼‰ã¸æ€¥è¡Œã›ã‚ˆï¼ã€ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ è·é›¢ï¼†æ°—å€™æƒ…å ±ã€‘ï½</h2>
        <p id="distanceInfo"></p>
        <div id="weatherInfo">
            <div>ï¼ ISS</div>
            <div id="issWeather">ISSä½ç½®ã®æ°—å€™: èª­ã¿è¾¼ã¿ä¸­...</div>
            <div id="bakachinInfo">ï¼ ãƒã‚«ãƒãƒ³ã‚¬ãƒ¼</div>
            <div id="userWeather">ãƒã‚«ãƒãƒ³ã‚¬ãƒ¼ä½ç½®ã®æ°—å€™: èª­ã¿è¾¼ã¿ä¸­...</div>
        </div>
        <div id="map"></div>
        <div>
            <li>ã€è±†çŸ¥è­˜ã€‘ISSã¯ç´„400kmä¸Šç©ºã®è»Œé“ã§ç´„90åˆ†ã§åœ°çƒã‚’ä¸€å‘¨ã—ã¦ã‚‹ã‚ˆ</li>
        </div>
        <button id="logout-button" style="display: none;">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
    </div>

    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <!-- Firebase -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
        import {
            getAuth,
            signInWithEmailAndPassword,
            createUserWithEmailAndPassword,
            onAuthStateChanged,
            signOut
        } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js";
        // Firebaseã®è¨­å®š
        const firebaseConfig = {
            apiKey: "",
            authDomain: "",
            databaseURL: "",
            projectId: "",
            storageBucket: "",
            messagingSenderId: "",
            appId: ""
        };
        // Firebaseã‚’åˆæœŸåŒ–
        const app = initializeApp(firebaseConfig);
        const auth = getAuth();

        // ãƒ­ã‚°ã‚¤ãƒ³é–¢æ•°
        function loginUser(email, password) {
            signInWithEmailAndPassword(auth, email, password)
                .then((userCredential) => {
                    // ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸ
                    console.log("Logged in as: ", userCredential.user);
                    $('#login-container').hide(); // ãƒ­ã‚°ã‚¤ãƒ³ãƒ•ã‚©ãƒ¼ãƒ ã‚’éš ã™
                    $('#content-container').show(); // ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ç”»é¢ã‚’è¡¨ç¤º
                    $('#logout-button').show(); // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
                })
                .catch((error) => {
                    //ãƒ­ã‚°ã‚¤ãƒ³å¤±æ•—
                    console.error("Login failed: ", error);
                });
        }

        // æ–°è¦ç™»éŒ²é–¢æ•°
        function signUpUser(email, password) {
            createUserWithEmailAndPassword(auth, email, password)
                .then((userCredential) => {
                    // æ–°è¦ç™»éŒ²æˆåŠŸ
                    console.log("Account created for: ", userCredential.user);
                })
                .catch((error) => {
                    //æ–°è¦ç™»éŒ²å¤±æ•—
                    console.error("Error in account creation: ", error);
                });
        }

        // ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ³ç¢ºèª
        onAuthStateChanged(auth, (user) => {
            if (user) {
                // ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹
                console.log("User is logged in: ", user);
            } else {
                // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆçŠ¶æ…‹
                console.log("User is logged out");
            }
        });

        // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆé–¢æ•°
        function logoutUser() {
            signOut(auth)
                .then(() => {
                    console.log("User logged out");
                })
                .catch((error) => {
                    console.error("Error in logging out: ", error);
                });
        }

        // ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ³ã«å¿œã˜ãŸè¡¨ç¤º
        onAuthStateChanged(auth, (user) => {
            //ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ã‚‹å ´åˆ
            if (user) {
                $('#login-container').hide();
                $('#content-container').show();
                $('#logout-button').show();
                //ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¦ã„ã‚‹å ´åˆ
            } else {
                $('#login-container').show();
                $('#content-container').hide();
                $('#logout-button').hide();
            }
        });

        // ãƒ­ã‚°ã‚¤ãƒ³ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆ
        $('#login-button').on('click', function () {
            const email = $('#login-email').val();
            const password = $('#login-password').val();
            loginUser(email, password);
        });

        // æ–°è¦ç™»éŒ²ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆ
        $('#signup-button').on('click', function () {
            const email = $('#signup-email').val();
            const password = $('#signup-password').val();
            signUpUser(email, password);
        });

        // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆ
        $('#logout-button').on('click', function () {
            logoutUser();
        });
    </script>

<!-- ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ç”»é¢ -->
    <script>
        let map;
        let issMarker, userMarker;
        let issInfoWindow, userInfoWindow;
        let issLat = 0;
        let issLng = 0;
        let userLat, userLng;

        function initMap() {
            map = new google.maps.Map($('#map')[0], {
                center: { lat: 0, lng: 0 },
                zoom: 2
            });

            issMarker = new google.maps.Marker({
                position: { lat: 0, lng: 0 },
                map: map,
                title: 'å›½éš›å®‡å®™ã‚¹ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆISSï¼‰'
            });

            issInfoWindow = new google.maps.InfoWindow({
                content: 'å›½éš›å®‡å®™ã‚¹ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆISSï¼‰'
            });

            issMarker.addListener('click', function () {
                issInfoWindow.open(map, issMarker);
            });

            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function (position) {
                    userLat = position.coords.latitude;
                    userLng = position.coords.longitude;

                    userMarker = new google.maps.Marker({
                        position: { lat: userLat, lng: userLng },
                        map: map,
                        title: 'ãƒã‚«ãƒãƒ³ã‚¬ãƒ¼ç¾åœ¨åœ°'
                    });

                    userInfoWindow = new google.maps.InfoWindow({
                        content: 'ãƒã‚«ãƒãƒ³ã‚¬ãƒ¼ç¾åœ¨åœ°'
                    });

                    userMarker.addListener('click', function () {
                        userInfoWindow.open(map, userMarker);
                    });

                    updateISS();
                }, function () {
                    handleLocationError(true, map.getCenter());
                });
            } else {
                // ãƒ–ãƒ©ã‚¦ã‚¶ãŒGeolocationã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ãªã„å ´åˆ
                handleLocationError(false, map.getCenter());
            }
        }

        let line;

        function updateISS() {
            $.getJSON('http://api.open-notify.org/iss-now.json', function (data) {
                issLat = parseFloat(data.iss_position.latitude);
                issLng = parseFloat(data.iss_position.longitude);

                issMarker.setPosition(new google.maps.LatLng(issLat, issLng));
                map.panTo(new google.maps.LatLng(issLat, issLng));

                issInfoWindow.setContent('å›½éš›å®‡å®™ã‚¹ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆISSï¼‰<br>ç·¯åº¦: ' + issLat.toFixed(2) + ', çµŒåº¦: ' + issLng.toFixed(2));

                if (userLat !== undefined && userLng !== undefined) {
                    let distance = calculateDistance(userLat, userLng, issLat, issLng);
                    $('#distanceInfo').text('ãƒã‚«ãƒãƒ³ã‚¬ãƒ¼åˆ°ç€ã¾ã§..  ' + distance.toFixed(2) + ' km');

                    // ãƒ©ã‚¤ãƒ³ä½œæˆãƒ»æ›´æ–°
                    if (line) {
                        line.setPath([
                            { lat: userLat, lng: userLng },
                            { lat: issLat, lng: issLng }
                        ]);
                    } else {
                        line = new google.maps.Polyline({
                            path: [
                                { lat: userLat, lng: userLng },
                                { lat: issLat, lng: issLng }
                            ],
                            geodesic: true,
                            strokeColor: '#FF0000',
                            strokeOpacity: 1.0,
                            strokeWeight: 2,
                            map: map
                        });
                    }
                }

                // ISSã®å¤©æ°—æƒ…å ±å–å¾—ï¼†è¡¨ç¤º
                getWeather(issLat, issLng, "#issWeather");

                // ãƒã‚«ãƒãƒ³ã‚¬ãƒ¼ã®å¤©æ°—æƒ…å ±å–å¾—ï¼†è¡¨ç¤º
                if (userLat !== undefined && userLng !== undefined) {
                    getWeather(userLat, userLng, "#userWeather");
                }
            });

            setTimeout(updateISS, 100000); // 5ç§’ã”ã¨ã«ä½ç½®ã‚’æ›´æ–°
        }

        // å¤©æ°—æƒ…å ±ã‚’å–å¾—ï¼†è¡¨ç¤ºé–¢æ•°
        function getWeather(lat, lon, elementId) {
            const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true`;

            $.getJSON(url, function (data) {
                if (data.current_weather) {
                    const weather = data.current_weather;
                    const temp = weather.temperature;
                    const windspeed = weather.windspeed;
                    $(elementId).text(`æ°—æ¸© ${temp}Â°Cã€€é¢¨é€Ÿ ${windspeed}km/h`);
                } else {
                    $(elementId).text("å¤©æ°—æƒ…å ±ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚");
                }
            });
        }

        function calculateDistance(lat1, lon1, lat2, lon2) {
            let R = 6371; // åœ°çƒã®åŠå¾„(km)
            let dLat = deg2rad(lat2 - lat1);
            let dLon = deg2rad(lon2 - lon1);
            let a =
                Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) *
                Math.sin(dLon / 2) * Math.sin(dLon / 2);
            let c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            let d = R * c; // è·é›¢(km)
            return d;
        }

        function deg2rad(deg) {
            return deg * (Math.PI / 180)
        }

        function handleLocationError(browserHasGeolocation, pos) {
            alert(browserHasGeolocation ?
                'ã‚¨ãƒ©ãƒ¼: Geolocationã‚µãƒ¼ãƒ“ã‚¹ãŒå¤±æ•—ã—ã¾ã—ãŸã€‚' :
                'ã‚¨ãƒ©ãƒ¼: ãŠä½¿ã„ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯Geolocationã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã›ã‚“ã€‚');
        }
    </script>

<!-- è¦API KEYè¿½åŠ  -->
    <script async defer
        src="https://maps.googleapis.com/maps/api/js?key=(ã“ã“ã«API_KEYè¿½åŠ )Q&callback=initMap">
        </script>

</body>

</html>